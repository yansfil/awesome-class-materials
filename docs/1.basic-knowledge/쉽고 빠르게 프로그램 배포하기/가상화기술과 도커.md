# 가상화 기술과 도커



<br>

## 가상화 기술

### 등장 배경

가상화 기술이란 하드웨어 리소스를 추상화하여 소프트웨어화 하는 기술을 말합니다. 예를 들어 우리는 가상화 기술을 통해 "CPU 1코어, Memory는 2Gi , 운영체제는 Ubuntu:16.04" 인 소프트웨어를 만들 수 있습니다. 실제로 이런 예의 대표적인 사례가 바로 AWS나 GCP, AZURE와 같은 클라우드 서비스입니다.

가상화 기술의 등장 이전에는 소프트웨어는 하드웨어에 크게 종속되었습니다.
그래서 아래와 같은 문제들이 있었습니다.

- 하나의 서비스를 제공하기 위해서는 하나의 컴퓨터 전체에 서버 프로그램을 띄워서 사용해야만 했습니다. 사용량이 적은 서비스더라도 컴퓨터의 CPU, Memory 등의 리소스를 전부 사용할 수 밖에 없었습니다.
- OS나 하드웨어의 특징에 따라 소프트웨어의 동작에 영향을 끼쳤습니다. 예를 들면 리눅스 컴퓨터에 서버를 운영하고 있는 회사에서 개발자들이 Window 컴퓨터, Mac 컴퓨터를 사용한다면 "내 컴퓨터에서는 됐지만 여기서는 왜 안돼"를 시전할 수 있게 됩니다.

그러나 가상화기술이 나오면서 이런 문제점들은 자연스럽게 해결되었습니다.
- 하드웨어 리소스도 추상화되었기에 서비스에 자원을 자유롭게 할당할 수 있습니다.
- OS에 관계없이 동일한 환경에서 소프트웨어를 구동할 수 있습니다.

실제로 클라우드(AWS, GCP 등)에서 우리가 사용하는 대부분의 서비스는 내부적으로 가상화 기술이 도입되어 있습니다.
우리가 클라우드에서 컴퓨팅 리소스를 빌릴 때 컴퓨터 한 대를 빌리는 게 아닌, 특정 리소스만큼 할당된 가상화 공간을 제공받는거죠.

### VM (Virtual Machine)

![blog/virtual-machine-architecture.jpg](https://nickjanetakis.com/assets/blog/virtual-machine-architecture-e6bcc9d42a12a12da38e92ba5a7ddef21e6bda269abc580a84ece64ac189d2b2.jpg)

(출처: https://nickjanetakis.com/blog/comparing-virtual-machines-vs-docker-containers)

VM은 하드웨어를 가상화하는 기술 중 하나입니다. 컴퓨터에 기본적으로 설치한 OS(Host OS) 위에 Hypervisor라는 소프트웨어를 통해 여러 OS(Guest OS)를 띄우고 컴퓨팅 리소스를 제어할 수 있습니다. 그리고 이렇게 만든 각각의 환경에서 애플리케이션을 독립적으로 실행할 수 있습니다.
예를 들어, VM으로 여러분이 사용하는 Window OS환경에서 별도의 Window, Mac OS, Linux 등의 OS를 동시에 올려두고 각 cpu, memory 사용량 등을 조정할 수 있습니다. 이렇게 하나의 컴퓨터로도 여러 개의 독립된 하드웨어 환경을 격리시켜 실행하는 것이 가능합니다.

그러나 VM의 가장 큰 단점이 있는데 바로 용량입니다. VM은 운영체제를 비롯한 실행 환경에 필요한 파일들을 "이미지" 라는 형태로 저장하고 있습니다. 그런데 이 이미지의 용량 자체가 꽤 큽니다. 따라서 VM으로 여러 가상환경을 운영하면, VM으로만으로도 많은 리소스가 낭비됩니다. (보통 이런걸 무겁다라고 표현합니다.)

또 하나의 단점은 실행환경의 부가적인 설정들을 완전히 구현하기 어려웠다는 점입니다. 예를 들어 우리가 실행 환경을 위해 리눅스 이미지를 사용하여 VM 가상환경을 구축한다고 해봅시다. 실제로 서버를 실행하려면 리눅스 이미지 위에 이런저런 라이브러리 설치를 더해주어야 하는데, 이런 내용이 이미지에 들어가있지는 않습니다. 따라서 단순히 "이미지"만 가지고 실행환경을 완전히 구현하기 어려웠습니다.

<br/>

### Docker (Container)
VM이 너무 무겁다는 불만이 나오는 가운데 Docker라고 하는 것이 등장합니다. Docker는 VM과 마찬가지로 실행환경을 가상화하여 실행시킬 수 있는 도구인데, VM보다 리소스를 덜 쓰며 훨씬 가볍습니다. VM에서는 "이미지"를 만드는 것이 시간이 오래걸리고 용량도 큰 작업이었는데, Docker에서는 비교적 빠르고 용량도 가볍습니다. Docker에서는 이 이미지를 "컨테이너 이미지"라고 부르는데, 누구나 쉽게 만들 수 있습니다.

도커를 사용하는 예시를 간단하게 살펴보겠습니다.
다음처럼 파이썬을 실행 환경을 만들고, 파이썬 코드를 실행하는 컨테이너 이미지를 만들 수 있습니다. (아래 코드는 `Dockerfile` 이라는 파일에 담깁니다.)

```Dockerfile
# 파이썬 코드를 실행하는 컨테이너 이미지를 만듭니다.
# 리눅스 우분투 컨테이너 이미지를 기반으로 만듭니다. (기반이 되는 이미지를 베이스 이미지라고 합니다.)
FROM ubuntu:18.04

# 리눅스 우분투 환경에 파이썬을 설치합니다.
RUN apt-get update -y
RUN apt-get install -y python-pip python-dev build-essential

# 우리가 작성한 파이썬 코드를 설치하고 실행합니다.
COPY .. /app
WORKDIR /app
RUN pip install -r requirements.txt
ENTRYPOINT ["python"]
CMD ["app.py"]
```

위에서는 베이스 이미지로 `ubuntu:18.04` 를 사용했지만, 다음처럼 파이썬이 이미 설치되어 있는 컨테이너 이미지를 베이스 이미지를 사용할 수도 있습니다.

```Dockerfile
# 파이썬 코드를 실행하는 컨테이너 이미지를 만듭니다.
# 파이썬 3.8 컨테이너 이미지를 베이스 이미지로 사용합니다.
FROM python:3.8

# 우리가 작성한 파이썬 코드를 설치하고 실행합니다.
COPY . /app
WORKDIR /app
RUN pip install -r requirements.txt
ENTRYPOINT ["python"]
CMD ["app.py"]
```

이후 다음처럼 도커 명령어로 위 `Dockerfile` 파일을 가지고 이미지를 만듭니다. (이를 보통 빌드한다고 합니다)

```bash
$ docker build . -t my-app
```

이렇게 만든 이미지는 다음처럼 도커 명령어로 확인할 수 있습니다.

```bash
$ docker images
REPOSITORY                   TAG                        IMAGE ID       CREATED        SIZE
my-app                       latest                     828b1334ba8f   24 hours ago   305MB
```

이렇게 만든 이미지는 다음처럼 실행 가능합니다.

```bash
$ docker run my-app
```

Dockerhub라고 하는 컨테이너 이미지 저장소에 이렇게 사용할 수 있는 컨테이너 이미지가 널려있습니다. 이렇게 공개되어 있는 컨테이너 이미지로 나만의 컨테이너 이미지를 만들 수 있고, 자신이 만든 컨테이너 이미지를 이미저 저장소에 공개할 수도 있습니다.

![불좀 꺼줄래? 내 Docker좀 보게 PART 4 - 실전 연습 - Docker hub 사용하기](https://d2uleea4buiacg.cloudfront.net/files/fa2/fa204630bed1deaf4e18a19a180f885934b613c6293584180ef1412fe8ed5283.m.png)

(Dockerhub 사이트: https://hub.docker.com/)

예를 들어 Dockerhub에 공개된 mysql 5.8 이미지를 사용하고 싶으면 다음처럼 docker 명령어를 입력하면 됩니다.

```bash
$ docker pull mysql:5.8
$ docker run mysql:5.8
```

이를 통해 컴퓨터에 손쉽게 mysql을 실행시킬 수 있습니다.

![Containers vs. Virtual Machines (VMs): What&#39;s the Difference? | NetApp Blog|Containers  vs. Virtual Machines (VMs): What&#39;s the Difference? | NetApp Blog](https://www.netapp.com/media/Screen-Shot-2018-03-20-at-9.24.09-AM_tcm19-56643.png)

(출처: https://www.netapp.com/blog/containers-vs-vms/)

Docker를 사용하면 다음과 같은 장점이 있습니다.

- VM보다 가벼우면서도 독립적인 실행환경을 갖출 수 있습니다.
    - docker는 VM과 다르게 Guest OS를 가지지 않도록 기술적으로 구현되었습니다. 이 점이 도커가 VM보다 가볍고 빠른 대표적인 이유입니다.
- `Dockerfile` 내에 실행하기 위한 모든 설정이 기록되어 있기 때문에, Docker 문법을 아는 사람이라면 쉽게 실행환경을 이해할 수 있고 재현할 수 있습니다.
- `Dockefile` 에 작성된 설정 말고는 별다른 의존성이 없습니다. 따라서 도커가 설치된 어느 컴퓨터에서든 도커 이미지를 실행시키면 동일한 실행환경위에 소프트웨어를 실행시킬 수 있습니다.

<br>
